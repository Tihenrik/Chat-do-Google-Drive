<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Chat</title>

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --primary-color: #059669;
            --bg-color: #e5ddd5;
            --white: #ffffff;
            --gray-light: #f0f2f5;
            --text-dark: #1f2937;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #app-container {
            width: 100%;
            max-width: 480px;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 500px) {
            body { align-items: center; padding: 20px; }
            #app-container { height: 85vh; border-radius: 20px; border: 1px solid #ddd; }
        }

        /* --- LOGIN --- */
        #login-screen {
            position: absolute; inset: 0;
            background: white;
            z-index: 100;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-icon {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px;
            box-shadow: var(--shadow);
        }

        input[type="text"] {
            width: 100%; padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            outline: none;
            font-size: 16px;
        }

        input[type="text"]:focus { border-color: var(--primary-color); }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .color-picker { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
        .color-dot {
            width: 35px; height: 35px; border-radius: 50%;
            border: 2px solid transparent; cursor: pointer;
            opacity: 0.6; transition: 0.2s;
        }
        .color-dot.active { opacity: 1; transform: scale(1.2); border-color: #ccc; }

        .error-banner {
            display: none;
            background: #fee2e2;
            color: #b91c1c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* --- CHAT --- */
        #chat-screen { display: none; flex-direction: column; height: 100%; }

        header {
            background: var(--primary-color);
            padding: 12px 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .avatar {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px;
        }

        #messages-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .msg {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: fadeIn .3s ease;
        }

        .msg.mine { background: #dcf8c6; align-self: flex-end; }
        .msg.theirs { background: white; align-self: flex-start; }

        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} }

        .msg-author { font-size: 10px; font-weight:bold; margin-bottom:2px; }
        .msg-meta { font-size: 10px; margin-top: 4px; text-align: right; }

        #input-area {
            padding: 10px;
            background: white;
            display: flex;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        #message-input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: none;
            background: #f3f4f6;
            outline:none;
        }

        #send-btn {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: var(--primary-color);
            color:white;
            display:flex; align-items:center; justify-content:center;
            border:none;
            cursor:pointer;
        }

        .hidden { display:none!important; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app-container">

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <div id="login-icon" class="login-icon">
                <i data-lucide="message-square" width="32" height="32"></i>
            </div>
            <h2 style="text-align:center; margin:0 0 5px;">Bem-vindo</h2>
            <p style="text-align:center; margin:0 0 15px; color:#666;">Digite um nome para entrar</p>

            <div id="login-error" class="error-banner"></div>

            <label>Seu nome</label>
            <input type="text" id="username-input" maxlength="20" placeholder="Ex: Ana Silva">

            <label style="margin-top:15px;">Cor do Tema</label>
            <div class="color-picker">
                <div class="color-dot active" style="background:#059669" onclick="selectColor('#059669', this)"></div>
                <div class="color-dot" style="background:#2563eb" onclick="selectColor('#2563eb', this)"></div>
                <div class="color-dot" style="background:#7c3aed" onclick="selectColor('#7c3aed', this)"></div>
                <div class="color-dot" style="background:#db2777" onclick="selectColor('#db2777', this)"></div>
                <div class="color-dot" style="background:#1f2937" onclick="selectColor('#1f2937', this)"></div>
            </div>

            <button class="btn-primary" onclick="handleLogin()">Entrar</button>
        </div>
    </div>

    <!-- CHAT -->
    <div id="chat-screen">

        <header id="chat-header">
            <div style="display:flex; gap:10px; align-items:center;">
                <div id="header-avatar" class="avatar">U</div>
                <div>
                    <div style="font-weight:bold; font-size:15px;">Chat</div>
                    <div id="header-username" style="font-size:11px;">Online</div>
                </div>
            </div>

            <div class="header-actions" style="display:flex; gap:8px;">
                <button onclick="forceUpdate()" title="Atualizar" style="background:none;border:none;color:white;">
                    <i data-lucide="refresh-cw" width="18"></i>
                </button>
                <button onclick="handleLogout()" title="Sair" style="background:none;border:none;color:white;">
                    <i data-lucide="log-out" width="18"></i>
                </button>
            </div>
        </header>

        <div id="messages-area"></div>

        <div id="input-area">
            <input type="text" id="message-input" placeholder="Digite uma mensagem..." onkeypress="checkEnter(event)">
            <button id="send-btn" onclick="sendMessage()">
                <i data-lucide="send" width="20"></i>
            </button>
        </div>

    </div>

</div>


<script>
    /* ======================================================
       CONFIGURAÇÃO: COLOQUE SUA URL DO APPS SCRIPT AQUI
    ====================================================== */
    const FIXED_API_URL = "https://script.google.com/macros/s/AKfycbzEwof2y587MZYFShrgifR8cL5ecARUorUi7BXCPguDXR4c3q_jlpyNma0GCde6aKO8/exec";

    let currentUser = "";
    let themeColor = "#059669";
    let lastMsgCount = 0;
    let pollInterval = null;

    /* ======================================================
       INICIALIZAÇÃO
    ====================================================== */
    window.onload = () => {
        lucide.createIcons();

        if (!FIXED_API_URL || FIXED_API_URL.length < 10) {
            document.getElementById("login-error").innerText =
                "ERRO: A URL do Script não foi configurada.";
            document.getElementById("login-error").style.display = "block";
            return;
        }

        const saved = localStorage.getItem("chat_prefs");
        if (saved) {
            const data = JSON.parse(saved);
            currentUser = data.user;
            themeColor = data.color;
            enterChatMode();
        }
    };

    /* ======================================================
       FUNÇÕES DE INTERFACE
    ====================================================== */
    function selectColor(color, el) {
        themeColor = color;
        document.querySelectorAll(".color-dot").forEach(d => d.classList.remove("active"));
        el.classList.add("active");

        document.getElementById("login-icon").style.background = color;
        document.querySelector(".btn-primary").style.background = color;
    }

    function handleLogin() {
        const name = document.getElementById("username-input").value.trim();

        if (!name) { alert("Digite seu nome."); return; }

        currentUser = name;

        localStorage.setItem("chat_prefs", JSON.stringify({
            user: currentUser,
            color: themeColor
        }));

        enterChatMode();
    }

    function handleLogout() {
        if (confirm("Deseja sair?")) {
            localStorage.removeItem("chat_prefs");
            clearInterval(pollInterval);
            location.reload();
        }
    }

    /* ======================================================
       ENTRAR NO CHAT
    ====================================================== */
    function enterChatMode() {
        document.documentElement.style.setProperty("--primary-color", themeColor);
        document.getElementById("chat-header").style.background = themeColor;
        document.getElementById("send-btn").style.background = themeColor;
        document.getElementById("header-avatar").innerText = currentUser.charAt(0).toUpperCase();
        document.getElementById("header-username").innerText = currentUser + " • Online";

        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("chat-screen").style.display = "flex";

        fetchMessages();
        startSmartPolling();
    }

    /* ======================================================
       SMART POLLING
    ====================================================== */
    function startSmartPolling() {
        let interval = 3000;

        pollInterval = setInterval(() => {
            fetchMessages();

            if (lastMsgCount > 0) {
                interval = 1500;
            }

        }, interval);

        document.getElementById("message-input").addEventListener("input", () => {
            clearInterval(pollInterval);
            pollInterval = setInterval(fetchMessages, 1000);
        });
    }

    /* ======================================================
       SOM QUANDO CHEGA NOVA MENSAGEM
    ====================================================== */
    function playNewMessageSound() {
        const audio = new Audio("data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAA…"); 
        audio.volume = 0.4;
        audio.play().catch(() => {});
    }

    /* ======================================================
       POLLING COM DETECÇÃO INSTANTÂNEA
    ====================================================== */
    async function fetchMessages() {
        try {
            const res = await fetch(`${FIXED_API_URL}?action=read&t=${Date.now()}`);
            const data = await res.json();

            if (!Array.isArray(data)) return;

            if (data.length !== lastMsgCount) {
                const isNew = data.length > lastMsgCount;
                lastMsgCount = data.length;

                renderMessages(data);

                if (isNew) playNewMessageSound();
            }

        } catch (err) {
            console.log("Polling falhou:", err);
        }
    }

    /* ======================================================
       FORÇAR ATUALIZAÇÃO
    ====================================================== */
    function forceUpdate() {
        const icon = document.querySelector('button[title="Atualizar"] svg');
        if (icon) {
            icon.style.animation = "spin 1s linear";
            setTimeout(() => icon.style.animation = "", 1000);
        }
        fetchMessages();
    }

    /* ======================================================
       ENVIAR MENSAGEM
    ====================================================== */
    async function sendMessage() {
        const input = document.getElementById("message-input");
        const text = input.value.trim();
        const btn = document.getElementById("send-btn");

        if (!text) return;

        input.value = "";
        input.disabled = true;
        btn.disabled = true;
        btn.innerHTML = "...";

        addMessageToScreen({
            user: currentUser,
            text: text,
            timestamp: new Date().toISOString(),
            pending: true
        });

        try {
            await fetch(`${FIXED_API_URL}?action=write&user=${encodeURIComponent(currentUser)}&text=${encodeURIComponent(text)}`);
            await fetchMessages();
        } catch {
            alert("Erro ao enviar mensagem.");
        }

        input.disabled = false;
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="send" width="20"></i>';
        lucide.createIcons();
        input.focus();
    }

    /* ======================================================
       RENDERIZAÇÃO
    ====================================================== */
    function renderMessages(list) {
        const box = document.getElementById("messages-area");
        box.innerHTML = "";

        list.forEach(m => addMessageToScreen(m));

        box.scrollTop = box.scrollHeight;
    }

    function addMessageToScreen(msg) {
        const box = document.getElementById("messages-area");
        const div = document.createElement("div");

        const isMe = msg.user === currentUser;
        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});

        div.className = `msg ${isMe?"mine":"theirs"}`;
        div.innerHTML = `
            ${!isMe ? `<div class="msg-author">${msg.user}</div>` : ""}
            <div>${msg.text}</div>
            <div class="msg-meta">${time}</div>
        `;

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function checkEnter(e) {
        if (e.key === "Enter") sendMessage();
    }
</script>

</body>
    </html>
